# Authentication Design

| Metadata | Value                             |
| -------- | --------------------------------- |
| Date     | 2025-05-08                        |
| Author   | [Liysx](mailto:liys87x@gmail.com) |
| Status   | Draft                             |
| Tags     | 0.1                               |

## 用户注册流程

- 用户填充基本信息: 邮箱、用户名、显示名、头像
- 系统检查邮箱是否已注册
- 系统检查用户名是否已注册
- 系统检查邮箱域是否在白名单中
- 系统生成初始密码
- 系统发送初始密码到邮箱
- 用户输入初始密码进行认证
- 要求用户在首次登录时修改密码

## 用户登录

### 用户名/邮箱+密码认证

- 用户通过提供用户名和密码进行基础认证
- 密码存储采用安全哈希算法(bcrypt)，不存储明文密码
- 可选启用双因子认证(2FA)，提供额外安全层级
  - 支持基于时间的一次性密码(TOTP)
  - 支持邮件验证码
- 认证成功后，生成 JWT Token
- 服务端记录登录时间及 IP 地址
- 检查用户是否需要强制修改密码

### 邮箱验证码认证

- 用户通过提供邮箱地址，系统发送验证码到邮箱
- 用户输入验证码进行认证
- 验证码有效期为 10 分钟
- 认证成功后，生成 JWT Token
- 服务端记录登录时间及 IP 地址
- 检查用户是否需要强制修改密码

### JWT Token 字段说明

- 标准字段
  - `sub`: 邮箱 or 用户名
  - `exp`: 过期时间
  - `iat`: 签发时间
  - `iss`: 签发者
  - `aud`: 受众
- 自定义字段
  - `tenant`: 租户名
  - `email`: 邮箱
  - `username`: 用户名
  - `role`: 角色
  - `is_superuser`: 是否为超级管理员

## 用户登出

- 用户登出时，客户端删除 JWT Token
- 服务端记录登出时间

## 码表

### 错误码表

| 错误码 | 描述             |
| ------ | ---------------- |
| 40001  | 验证码错误       |
| 40002  | 验证码过期       |
| 40003  | 验证码发送失败   |
| 40101  | 用户名或密码错误 |
| 40102  | 用户不存在       |
| 40103  | 用户已锁定       |
| 40104  | 用户已禁用       |
| 40201  | 不允许自主注册   |
| 40202  | 不允许的邮箱域   |

### 用户锁定码表

| 错误码 | 描述                                                            |
| ------ | --------------------------------------------------------------- |
| 50001  | 连续错误 3 次临时锁定, 10 分钟内不能登录                        |
| 50002  | 连续错误 5 次永久锁定, 需管理员解锁                             |
| 50003  | 超过最大登录次数, 10 分钟内连续登录 20 次临时锁定, 2 小时后解锁 |
| 50101  | 租户管理员手动锁定                                              |
| 50102  | 系统管理员手动锁定                                              |
| 50201  | 首次登录未修改密码, 强制修改密码                                |
| 50202  | 连续 180 天未修改密码, 强制修改密码                             |
| 50301  | 邮箱未验证, 需要验证邮箱                                        |
